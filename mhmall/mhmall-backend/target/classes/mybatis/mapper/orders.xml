<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="orders">

	<!-- 주문리스트 -->
	<select id="selectList" resultType="ordersvo">
		select orders_no as ordersNo, reg_date as regDate, status, bank_name as bankName, bank_num as bankNum, pay_date as payDate, money, tracking_num as trackingNum,

		cast(AES_DECRYPT(to_name, #{aesKey}) as char) as toName,
		cast(AES_DECRYPT(to_phone, #{aesKey}) as char) as toPhone,
		cast(AES_DECRYPT(to_zipcode, #{aesKey}) as char) as toZipcode,
		cast(AES_DECRYPT(to_addr, #{aesKey}) as char) as toAddr,
		cast(AES_DECRYPT(member_id, #{aesKey}) as char) as memberId
		
		from orders order by orders_no desc
	</select>
	
	
	<!-- 주문상세 -->
	<select id="selectOne" parameterType="ordersvo" resultType="ordersvo">
		select orders_no as ordersNo, reg_date as regDate, status, bank_name as bankName, bank_num as bankNum, pay_date as payDate, money, tracking_num as trackingNum,

		cast(AES_DECRYPT(to_name, #{aesKey}) as char) as toName,
		cast(AES_DECRYPT(to_phone, #{aesKey}) as char) as toPhone,
		cast(AES_DECRYPT(to_zipcode, #{aesKey}) as char) as toZipcode,
		cast(AES_DECRYPT(to_addr, #{aesKey}) as char) as toAddr,
		cast(AES_DECRYPT(member_id, #{aesKey}) as char) as memberId
		
		from orders
		where orders_no=#{ordersNo}
	</select>
	
	
	<!-- 상태변경 -->
	<update id="updateStatus" parameterType="java.util.Map">
		update orders set
		status=#{status}
		where orders_no=#{ordersNo}
	</update>
	
	
	<!-- 운송장번호 입력 -->
	<update id="updateTrackingNum" parameterType="java.util.Map">
		update orders set
		tracking_num=#{trackingNum}
		where orders_no=#{ordersNo}
	</update>
	
	
	<!-- 주문 작성 -->
	<select id="insert" parameterType="ordersvo" resultType="String">
		select (select concat(DATE_FORMAT(now(),'%Y%m%d'), '_', LPAD(count(a.reg_date)+1, 5, 0))
			from orders a
			where DATE_FORMAT(a.reg_date,'%Y%m%d') = DATE_FORMAT(now(),'%Y%m%d')) as ordersNo;
			
		insert into orders values(
		(
			select concat(DATE_FORMAT(now(),'%Y%m%d'), '_', LPAD(count(a.reg_date)+1, 5, 0))
			from orders a
			where DATE_FORMAT(a.reg_date,'%Y%m%d') = DATE_FORMAT(now(),'%Y%m%d')
		),
		now(),
		#{status},
		#{bankName},
		#{bankNum},
		null,
		#{money},
		null,
		null,
		null,
		null,
		null,
		null
		)
	</select>
	
	
	
	
	
</mapper>
